#!/bin/bash
set -e
VERSION="1.0.0"
WORKDIR="/tmp/mkobsidianiso-$$"
DISTRO="ObsidianOS"   # config
ISO_NAME="OBSIDIANOS" # config
ISO_VERSION="1.0.0"   # config
EXTRA_GRUB_CONFIG=""  # config
BUSYBOX=""            # config
error() {
  echo "ERROR: $*" >&2
  exit 1
}

info() {
  echo "=> $*"
}

cleanup() {
  info "Cleaning up..."
  rm -rf "$WORKDIR"
}

trap cleanup EXIT
show_help() {
  cat <<EOF
mkobsidianiso - Create bootable live ISO from a system image

Usage: mkobsidianiso [OPTIONS] <config> <rootfs> <output.iso>

Arguments:
  <config>        Config file path
  <rootfs>        Source root filesystem (directory or squashfs system image)
  <output.iso>    Output ISO file path

Config options:
  DISTRO            Distro name in the GRUB menu
  ISO_NAME          ISO File Product Name
  ISO_VERSION       ISO File Product Version
  EXTRA_GRUB_CONFIG Extra options like menu entries for GRUB
  BUSYBOX           Busybox binary path

Options:
  -k, --kernel    Specify kernel version (auto-detect if not provided)
  -h, --help      Show this help message
  -v, --version   Show version

Examples:
  mkobsidianiso /path/to/rootfs output.iso
  mkobsidianiso -k 6.12.62_1 rootfs.sfs output.iso

EOF
}

detect_kernel() {
  local rootfs="$1"
  local mount_needed=false
  local mount_point=""
  if [[ -f "$rootfs" ]]; then
    mount_point="$WORKDIR/detect_mount"
    mkdir -p "$mount_point"
    mount -o loop,ro "$rootfs" "$mount_point" 2>/dev/null || error "Failed to mount $rootfs for kernel detection"
    mount_needed=true
    rootfs="$mount_point"
  fi
  local kernel=$(ls "$rootfs/boot/vmlinuz-"* 2>/dev/null | head -n1 | xargs basename | sed 's/vmlinuz-//')
  if $mount_needed; then
    umount "$mount_point"
  fi
  [[ -z "$kernel" ]] && error "Could not detect kernel version. Use -k to specify manually."
  echo "$kernel"
}

extract_modules() {
  local rootfs="$1"
  local kernel="$2"
  local dest="$3"
  local mount_needed=false
  local mount_point=""
  if [[ -f "$rootfs" ]]; then
    mount_point="$WORKDIR/module_mount"
    mkdir -p "$mount_point"
    mount -o loop,ro "$rootfs" "$mount_point" || error "Failed to mount $rootfs"
    mount_needed=true
    rootfs="$mount_point"
  fi
  local mod_dir="$rootfs/lib/modules/$kernel/kernel"
  [[ ! -d "$mod_dir" ]] && error "Kernel modules not found at $mod_dir"
  info "Extracting kernel modules..."
  local modules=(
    "fs/squashfs/squashfs.ko"
    "drivers/block/loop.ko"
    "fs/overlayfs/overlay.ko"
  )

  for mod in "${modules[@]}"; do
    local src="$mod_dir/$mod"
    [[ -f "$src.zst" ]] && src="$src.zst"
    [[ ! -f "$src" ]] && error "Module not found: $mod"
    cp "$src" "$dest/"
  done

  cd "$dest"
  if ls *.zst &>/dev/null; then
    info "Decompressing modules..."
    unzstd *.zst || error "Failed to decompress modules"
    rm -f *.zst
  fi

  if $mount_needed; then
    umount "$mount_point"
  fi
}

create_init_script() {
  local dest="$1"
  cat >"$dest" <<'INITEOF'
#!/sbin/busybox sh
echo "=> mkobsidianiso"
echo "=> inserting kernel modules"
insmod /extras/loop.ko || (echo "=> ERROR: UNABLE TO INSERT LOOPBACK KERNEL MODULE" && sleep 1000)
insmod /extras/squashfs.ko || (echo "=> ERROR: UNABLE TO INSERT SQUASHFS KERNEL MODULE" && sleep 1000)
insmod /extras/overlay.ko || (echo "=> ERROR: UNABLE TO INSERT OVERLAYFS KERNEL MODULE" && sleep 1000)
echo "=> setting up loopback device"
mknod /dev/loop0 b 7 0 2>/dev/null
losetup /dev/loop0 /live/system.sfs
echo "=> mounting overlay"
mkdir -p /lower /upper /work /newroot 2>/dev/null
mount -t squashfs /dev/loop0 /lower 2>/dev/null
mount -t tmpfs tmpfs /upper 2>/dev/null
mkdir -p /upper/upper /upper/work 2>/dev/null
mount -t overlay overlay -o lowerdir=/lower,upperdir=/upper/upper,workdir=/upper/work /newroot 2>/dev/null
echo "=> moving essential mounts"
mount --move /dev /newroot/dev 2>/dev/null
mount --move /proc /newroot/proc 2>/dev/null
mount --move /sys /newroot/sys 2>/dev/null
echo "=> changing root"
cd /newroot
pivot_root . tmp || (echo "=> ERROR: UNABLE TO PIVOT ROOT (VERY CRITICAL!!!)" && sleep 1000)
echo "=> mounting the live CD at /mnt/livecd"
mkdir -p /mnt/livecd
mount --move /tmp/ /mnt/livecd
echo "=> symlinking (forcefully!) system image to /etc/system.sfs"
ln -sf /mnt/livecd/live/system.sfs /etc/system.sfs || (echo "=> ERROR: UNABLE TO SYMLINK SYSTEM IMAGE" && sleep 1000)
echo "=> giving the job to the system. bye from mkobsidianiso"
exec /sbin/init
INITEOF
  chmod +x "$dest"
}

create_grub_cfg() {
  local dest="$1"
  local kernel="$2"
  cat >"$dest" <<EOF
set default=0
set timeout=5
menuentry "$DISTRO" {
    search --no-floppy --set=root --file /live/system.sfs
    loopback loop0 (\$root)/live/system.sfs
    linux (loop0)/boot/vmlinuz-$kernel root=/dev/sr0 rootfstype=iso9660 ro
    initrd (loop0)/boot/initramfs-$kernel.img
    boot
}
$EXTRA_GRUB_CONFIG
EOF
}

create_squashfs() {
  local src="$1"
  local dest="$2"
  info "Creating system image from $src..."
  mksquashfs "$src" "$dest" -comp xz -b 1M -Xdict-size 100% || error "Failed to create squashfs"
}

main() {
  old_pwd="$PWD"
  local kernel_version=""
  local rootfs=""
  local output=""
  local config=""
  while [[ $# -gt 0 ]]; do
    case $1 in
    -h | --help)
      show_help
      exit 0
      ;;
    -v | --version)
      echo "mkobsidianiso $VERSION"
      exit 0
      ;;
    -k | --kernel)
      kernel_version="$2"
      shift 2
      ;;
    -*)
      error "Unknown option: $1"
      ;;
    *)
      if [[ -z "$config" ]]; then
        config="$1"
        source "$config"
      else
        if [[ -z "$rootfs" ]]; then
          rootfs="$1"
        elif [[ -z "$output" ]]; then
          output="$1"
        else
          error "Too many arguments"
        fi
      fi
      shift
      ;;
    esac
  done

  [[ -z "$rootfs" ]] && error "No rootfs specified. Use -h for help."
  [[ -z "$output" ]] && error "No output file specified. Use -h for help."
  [[ ! -e "$rootfs" ]] && error "Rootfs not found: $rootfs"
  [[ ! -e "$config" ]] && error "Config file not specified."
  [[ $EUID -ne 0 ]] && error "This script must be run as root"
  command -v mksquashfs &>/dev/null || error "mksquashfs not found. Install squashfs-tools."
  command -v grub-mkrescue &>/dev/null || error "grub-mkrescue not found. Install grub."
  command -v unzstd &>/dev/null || error "unzstd not found. Install zstd."
  mkdir -p "$WORKDIR"
  if [[ -z "$kernel_version" ]]; then
    info "Auto-detecting kernel version..."
    kernel_version=$(detect_kernel "$rootfs")
  fi
  info "Using kernel version: $kernel_version"
  local iso_root="$WORKDIR/iso"
  mkdir -p "$iso_root"/{boot/grub,sbin,extras,live,dev,proc,sys,newroot,lower,upper/{work,upper},work}
  local squashfs_file="$iso_root/live/system.sfs"
  if [[ -d "$rootfs" ]]; then
    create_squashfs "$rootfs" "$squashfs_file"
  elif [[ -f "$rootfs" ]]; then
    info "Using existing squashfs: $rootfs"
    cp "$rootfs" "$squashfs_file"
  else
    error "Invalid rootfs type"
  fi
  extract_modules "$squashfs_file" "$kernel_version" "$iso_root/extras"
  info "Installing busybox..."
  if command -v "$BUSYBOX" &>/dev/null; then
    cp "$BUSYBOX" "$iso_root/sbin/busybox"
  else
    if command -v busybox &>/dev/null; then
      cp "$(command -v busybox)" "$iso_root/sbin/"
    else
      error "busybox not found. Please install busybox-static. Or run $(curl -fsSL https://files.obsidianos.xyz/~odd/static/busybox -o /usr/bin/)"
    fi
  fi
  info "Creating init script..."
  create_init_script "$iso_root/sbin/init"
  info "Creating GRUB configuration..."
  create_grub_cfg "$iso_root/boot/grub/grub.cfg" "$kernel_version"
  info "Building ISO with grub-mkrescue..."
  cd "$old_pwd"
  grub-mkrescue -o "$output" "$iso_root" --product-name="$ISO_NAME" --product-version="$ISO_VERSION" || error "Failed to create ISO"
  info "Success! ISO created at: $output"
  info "Size: $(du -h "$output" | cut -f1)"
}

main "$@"
